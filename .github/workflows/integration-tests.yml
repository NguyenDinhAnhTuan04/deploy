# Integration Tests CI/CD Workflow
# Automated testing pipeline for complete system integration

name: Integration Tests

on:
  push:
    branches:
      - main
      - develop
      - "feature/**"
  pull_request:
    branches:
      - main
      - develop
  schedule:
    # Run daily at 2 AM UTC
    - cron: "0 2 * * *"
  workflow_dispatch:
    # Allow manual trigger

env:
  PYTHON_VERSION: "3.10"
  DOCKER_COMPOSE_VERSION: "2.23.0"
  COVERAGE_THRESHOLD: 15

jobs:
  # ==========================================================================
  # LINT AND TYPE CHECK
  # ==========================================================================

  lint:
    name: Lint and Type Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: "pip"
          cache-dependency-path: "Builder-Layer-End/requirements.txt"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install flake8 mypy black isort pylint
          pip install -r Builder-Layer-End/requirements.txt

      - name: Run Black (code formatting check)
        continue-on-error: true
        run: black --check Builder-Layer-End/agents/ Builder-Layer-End/tests/

      - name: Run isort (import sorting check)
        continue-on-error: true
        run: isort --check-only Builder-Layer-End/agents/ Builder-Layer-End/tests/

      - name: Run flake8 (linting)
        continue-on-error: true
        run: flake8 Builder-Layer-End/agents/ Builder-Layer-End/tests/ --max-line-length=100 --ignore=E203,W503

      - name: Run mypy (type checking)
        continue-on-error: true
        run: mypy Builder-Layer-End/agents/ --ignore-missing-imports

      - name: Run pylint (code quality)
        continue-on-error: true
        run: pylint Builder-Layer-End/agents/ --disable=C0111,R0903,W0212 --max-line-length=100

  # ==========================================================================
  # UNIT TESTS
  # ==========================================================================

  unit-tests:
    name: Unit Tests
    runs-on: ubuntu-latest
    needs: lint
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: "pip"
          cache-dependency-path: "Builder-Layer-End/requirements.txt"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r Builder-Layer-End/requirements.txt
          pip install pytest pytest-cov pytest-asyncio pytest-mock

      - name: Run unit tests
        continue-on-error: true
        run: |
          pytest Builder-Layer-End/tests/ \
            -v \
            --ignore=Builder-Layer-End/tests/integration/ \
            --cov=Builder-Layer-End/agents \
            --cov-report=xml \
            --cov-report=term-missing \
            --cov-fail-under=${{ env.COVERAGE_THRESHOLD }}

      - name: Upload coverage to Codecov
        if: always()
        uses: codecov/codecov-action@v3
        with:
          files: ./coverage.xml
          flags: unittests
          name: codecov-unit

  # ==========================================================================
  # INTEGRATION TESTS
  # ==========================================================================

  integration-tests:
    name: Integration Tests
    runs-on: ubuntu-latest
    needs: unit-tests
    timeout-minutes: 30

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Cache Docker layers
        uses: actions/cache@v3
        with:
          path: /tmp/.buildx-cache
          key: ${{ runner.os }}-buildx-${{ github.sha }}
          restore-keys: |
            ${{ runner.os }}-buildx-

      - name: Start Docker Compose stack
        run: |
          docker compose -f Builder-Layer-End/docker-compose.test.yml up -d
          echo "Waiting for services to be healthy..."
          sleep 60

      - name: Check service health
        run: |
          docker compose -f Builder-Layer-End/docker-compose.test.yml ps

          # Check Stellio
          curl -f http://localhost:8080/actuator/health || exit 1

          # Check Fuseki
          curl -f http://localhost:3030/$/ping || exit 1

          # Check Neo4j
          docker compose -f Builder-Layer-End/docker-compose.test.yml exec -T neo4j cypher-shell -u neo4j -p test12345 "RETURN 1" || exit 1

          echo "All services are healthy"

      - name: Run integration tests
        continue-on-error: true
        run: |
          docker compose -f Builder-Layer-End/docker-compose.test.yml run --rm test-runner \
            pytest tests/integration/test_complete_system.py \
            -v \
            --cov=agents \
            --cov-report=xml \
            --cov-report=term-missing \
            --durations=10 \
            --tb=short \
            -m "integration"

      - name: Copy coverage reports
        if: always()
        run: |
          docker cp test-runner:/app/coverage.xml ./coverage.xml || true

      - name: Upload coverage to Codecov
        if: always()
        uses: codecov/codecov-action@v3
        with:
          files: ./coverage.xml
          flags: integration
          name: codecov-integration

      - name: Print Docker logs on failure
        if: failure()
        run: |
          docker compose -f Builder-Layer-End/docker-compose.test.yml logs stellio-api-gateway
          docker compose -f Builder-Layer-End/docker-compose.test.yml logs neo4j
          docker compose -f Builder-Layer-End/docker-compose.test.yml logs fuseki
          docker compose -f Builder-Layer-End/docker-compose.test.yml logs redis

      - name: Cleanup Docker stack
        if: always()
        run: |
          docker compose -f Builder-Layer-End/docker-compose.test.yml down -v

  # ==========================================================================
  # PERFORMANCE TESTS
  # ==========================================================================

  performance-tests:
    name: Performance Tests
    runs-on: ubuntu-latest
    needs: integration-tests
    timeout-minutes: 20

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Start Docker Compose stack
        run: |
          docker compose -f Builder-Layer-End/docker-compose.test.yml up -d
          echo "Waiting for services..."
          sleep 60

      - name: Run performance benchmarks
        continue-on-error: true
        run: |
          docker compose -f Builder-Layer-End/docker-compose.test.yml run --rm test-runner \
            pytest tests/integration/test_complete_system.py \
            -v \
            -m "performance" \
            --durations=10 \
            --tb=short

      - name: Cleanup
        if: always()
        run: docker compose -f Builder-Layer-End/docker-compose.test.yml down -v

  # ==========================================================================
  # E2E TESTS (Full 722-camera pipeline)
  # ==========================================================================

  e2e-tests:
    name: End-to-End Tests (722 Cameras)
    runs-on: ubuntu-latest
    needs: integration-tests
    timeout-minutes: 45
    if: github.event_name == 'push' || github.event_name == 'schedule'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Start Docker Compose stack
        run: |
          docker compose -f Builder-Layer-End/docker-compose.test.yml up -d
          echo "Waiting for services..."
          sleep 90

      - name: Generate test data
        run: |
          docker compose -f Builder-Layer-End/docker-compose.test.yml run --rm test-runner \
            python -c "from tests.integration.test_complete_system import *; print('Generating test data...')"

      - name: Run E2E pipeline test
        continue-on-error: true
        run: |
          docker compose -f Builder-Layer-End/docker-compose.test.yml run --rm test-runner \
            pytest tests/integration/test_complete_system.py::TestCompleteSystem::test_full_pipeline_722_cameras \
            -v \
            --tb=short \
            --durations=10

      - name: Cleanup
        if: always()
        run: docker compose -f Builder-Layer-End/docker-compose.test.yml down -v

  # ==========================================================================
  # SECURITY SCAN
  # ==========================================================================

  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest
    needs: lint

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install safety bandit

      - name: Run Safety (dependency vulnerability scan)
        continue-on-error: true
        run: safety check --json

      - name: Run Bandit (security issues scan)
        continue-on-error: true
        run: bandit -r Builder-Layer-End/agents/ -f json -o bandit-report.json

      - name: Upload Bandit report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: bandit-report
          path: bandit-report.json

  # ==========================================================================
  # BUILD DOCKER IMAGES
  # ==========================================================================

  build-docker:
    name: Build Docker Images
    runs-on: ubuntu-latest
    needs: [integration-tests, e2e-tests]
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Build and push test image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile.test
          push: true
          tags: |
            ${{ secrets.DOCKERHUB_USERNAME }}/builder-layer-test:latest
            ${{ secrets.DOCKERHUB_USERNAME }}/builder-layer-test:${{ github.sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  # ==========================================================================
  # DEPLOY DOCUMENTATION
  # ==========================================================================

  deploy-docs:
    name: Deploy Documentation
    runs-on: ubuntu-latest
    needs: [integration-tests]
    if: false  # Disabled - mkdocs.yml not present

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install MkDocs
        run: |
          pip install mkdocs mkdocs-material mkdocstrings

      - name: Build documentation
        run: mkdocs build

      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./site

  # ==========================================================================
  # NOTIFICATION
  # ==========================================================================

  notify:
    name: Notify Results
    runs-on: ubuntu-latest
    needs:
      [lint, unit-tests, integration-tests, performance-tests, security-scan]
    if: always()

    steps:
      - name: Send Slack notification
        if: failure()
        uses: slackapi/slack-github-action@v1.24.0
        with:
          payload: |
            {
              "text": "❌ Integration Tests Failed",
              "blocks": [
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "*Integration Tests Failed*\n\nWorkflow: ${{ github.workflow }}\nBranch: ${{ github.ref }}\nCommit: ${{ github.sha }}\n\n<${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}|View Run>"
                  }
                }
              ]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

      - name: Comment on PR
        if: github.event_name == 'pull_request' && failure()
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: '❌ Integration tests failed. Please check the [workflow run](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}) for details.'
            })
