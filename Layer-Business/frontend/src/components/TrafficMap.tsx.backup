import React from 'react';
import { 
  MapContainer, 
  TileLayer, 
  Marker, 
  Popup, 
  Polyline, 
  LayersControl, 
  ScaleControl, 
  ZoomControl,
  Tooltip
} from 'react-leaflet';
import { Icon, LatLngExpression } from 'leaflet';
import { useTrafficStore } from '../store/trafficStore';
import { Camera, Accident, Weather, AirQuality, TrafficPattern } from '../types';
import { format, subHours, parseISO } from 'date-fns';
import 'leaflet/dist/leaflet.css';

const { BaseLayer, Overlay } = LayersControl;

const createCameraIcon = (type: string = 'Static', status: string = 'active'): Icon => {
  const color = status === 'active' || status === 'online' ? 'blue' : 'red';
  return new Icon({
    iconUrl: `https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-${color}.png`,
    shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/images/marker-shadow.png',
    iconSize: [25, 41],
    iconAnchor: [12, 41],
    popupAnchor: [1, -34],
    shadowSize: [41, 41],
  });
};

const accidentIconBySeverity = (severity: string): Icon => {
  const colorMap: Record<string, string> = {
    'fatal': 'black',
    'severe': 'red',
    'moderate': 'orange',
    'minor': 'yellow',
  };
  const color = colorMap[severity] || 'red';
  return new Icon({
    iconUrl: `https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-${color}.png`,
    shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/images/marker-shadow.png',
    iconSize: [25, 41],
    iconAnchor: [12, 41],
    popupAnchor: [1, -34],
    shadowSize: [41, 41],
  });
};

const weatherIcon = new Icon({
  iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-green.png',
  shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/images/marker-shadow.png',
  iconSize: [25, 41],
  iconAnchor: [12, 41],
  popupAnchor: [1, -34],
  shadowSize: [41, 41],
});

const airQualityIconByLevel = (level: string): Icon => {
  const colorMap: Record<string, string> = {
    'good': 'green',
    'moderate': 'yellow',
    'unhealthy': 'orange',
    'very_unhealthy': 'red',
    'hazardous': 'violet',
  };
  const color = colorMap[level] || 'grey';
  return new Icon({
    iconUrl: `https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-${color}.png`,
    shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/images/marker-shadow.png',
    iconSize: [25, 41],
    iconAnchor: [12, 41],
    popupAnchor: [1, -34],
    shadowSize: [41, 41],
  });
};

const TrafficMap: React.FC = () => {
  const {
    cameras,
    accidents,
    weather,
    airQuality,
    patterns,
    filters,
    setSelectedCamera,
    setSelectedAccident,
    setSelectedPattern,
  } = useTrafficStore();

  const center: LatLngExpression = [10.8231, 106.6297];

  const getCongestionColor = (level: string): string => {
    const levelNormalized = level.toLowerCase();
    switch (levelNormalized) {
      case 'free_flow':
      case 'low':
        return '#00FF00';
      case 'light':
        return '#90EE90';
      case 'moderate':
      case 'medium':
        return '#FFFF00';
      case 'heavy':
      case 'high':
        return '#FFA500';
      case 'severe':
        return '#FF0000';
      default:
        return '#808080';
    }
  };

  const getAQIColor = (level: string): string => {
    switch (level) {
      case 'good':
        return '#00E400';
      case 'moderate':
        return '#FFFF00';
      case 'unhealthy':
        return '#FF7E00';
      case 'very_unhealthy':
        return '#FF0000';
      case 'hazardous':
        return '#8F3F97';
      default:
        return '#808080';
    }
  };

  const getRecentAccidentsCount = (cameraLat: number, cameraLng: number, radius: number = 0.01): number => {
    const twentyFourHoursAgo = subHours(new Date(), 24);
    return accidents.filter(accident => {
      const accidentTime = parseISO(accident.timestamp || accident.dateDetected || new Date().toISOString());
      const isRecent = accidentTime >= twentyFourHoursAgo;
      const distance = Math.sqrt(
        Math.pow(accident.location.latitude - cameraLat, 2) + 
        Math.pow(accident.location.longitude - cameraLng, 2)
      );
      return isRecent && distance <= radius;
    }).length;
  };

  const getWeatherAtLocation = (lat: number, lng: number): Weather | null => {
    if (weather.length === 0) return null;
    
    let closest: Weather | null = null;
    let minDistance = Infinity;
    
    weather.forEach(w => {
      const distance = Math.sqrt(
        Math.pow(w.location.latitude - lat, 2) + 
        Math.pow(w.location.longitude - lng, 2)
      );
      if (distance < minDistance) {
        minDistance = distance;
        closest = w;
      }
    });
    
    return closest;
  };

  const getAQIAtLocation = (lat: number, lng: number): AirQuality | null => {
    if (airQuality.length === 0) return null;
    
    let closest: AirQuality | null = null;
    let minDistance = Infinity;
    
    airQuality.forEach(aq => {
      const distance = Math.sqrt(
        Math.pow(aq.location.latitude - lat, 2) + 
        Math.pow(aq.location.longitude - lng, 2)
      );
      if (distance < minDistance) {
        minDistance = distance;
        closest = aq;
      }
    });
    
    return closest;
  };

  return (
    <MapContainer
      center={center}
      zoom={13}
      minZoom={11}
      maxZoom={18}
      style={{ height: '100%', width: '100%' }}
      className="z-0"
      zoomControl={false}
    >
      <ZoomControl position="topright" />
      <ScaleControl position="bottomleft" />

      <LayersControl position="topright">
        <BaseLayer checked name="OpenStreetMap">
          <TileLayer
            url="https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png"
            attribution='&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
          />
        </BaseLayer>
        <BaseLayer name="Satellite">
          <TileLayer
            url="https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}"
            attribution='Tiles &copy; Esri'
          />
        </BaseLayer>

        <Overlay checked={filters.showCameras} name="Cameras">
          <>
            {cameras.map((camera: Camera) => {
              const nearbyWeather = getWeatherAtLocation(camera.location.latitude, camera.location.longitude);
              const nearbyAQI = getAQIAtLocation(camera.location.latitude, camera.location.longitude);
              const recentAccidents = getRecentAccidentsCount(camera.location.latitude, camera.location.longitude);

              return (
                <Marker
                  key={camera.id}
                  position={[camera.location.latitude, camera.location.longitude]}
                  icon={createCameraIcon(camera.type, camera.status)}
                  eventHandlers={{
                    click: () => setSelectedCamera(camera),
                  }}
                >
                  <Tooltip direction="top" offset={[0, -40]} opacity={0.9}>
                    <strong>{camera.name}</strong>
                  </Tooltip>
                  <Popup>
                    <div className="p-3 min-w-[280px]">
                      <h3 className="font-bold text-lg mb-2">{camera.name}</h3>
                      <p className="text-sm text-gray-600 mb-2">{camera.location.address}</p>
                      
                      <div className="space-y-1 mb-3">
                        <p className="text-sm">
                          <span className="font-semibold">Type:</span> {camera.type || 'Static'}
                        </p>
                        <p className="text-sm">
                          <span className="font-semibold">Status:</span>{' '}
                          <span
                            className={`font-semibold ${
                              camera.status === 'active' || camera.status === 'online'
                                ? 'text-green-600'
                                : camera.status === 'inactive' || camera.status === 'offline'
                                ? 'text-red-600'
                                : 'text-yellow-600'
                            }`}
                          >
                            {camera.status}
                          </span>
                        </p>
                      </div>

                      {nearbyWeather && (
                        <div className="border-t pt-2 mb-2">
                          <p className="text-xs font-semibold text-gray-700 mb-1">Current Weather:</p>
                          <p className="text-sm">{nearbyWeather.temperature}°C, {nearbyWeather.condition}</p>
                          <p className="text-xs text-gray-600">Humidity: {nearbyWeather.humidity}%</p>
                        </div>
                      )}

                      {nearbyAQI && (
                        <div className="border-t pt-2 mb-2">
                          <p className="text-xs font-semibold text-gray-700 mb-1">Air Quality:</p>
                          <p className="text-sm">
                            AQI: <span style={{ color: getAQIColor(nearbyAQI.level), fontWeight: 'bold' }}>
                              {nearbyAQI.aqi}
                            </span> ({nearbyAQI.level})
                          </p>
                        </div>
                      )}

                      <div className="border-t pt-2">
                        <p className="text-sm">
                          <span className="font-semibold">Recent Accidents (24h):</span>{' '}
                          <span className={recentAccidents > 0 ? 'text-red-600 font-bold' : 'text-green-600'}>
                            {recentAccidents}
                          </span>
                        </p>
                      </div>

                      {camera.streamUrl && (
                        <a
                          href={camera.streamUrl}
                          target="_blank"
                          rel="noopener noreferrer"
                          className="block mt-3 text-center bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 text-sm"
                        >
                          View Stream
                        </a>
                      )}
                      
                      <button
                        onClick={() => setSelectedCamera(camera)}
                        className="block w-full mt-2 text-center bg-gray-600 text-white px-4 py-2 rounded hover:bg-gray-700 text-sm"
                      >
                        View Details
                      </button>
                    </div>
                  </Popup>
                </Marker>
              );
            })}
          </>
        </Overlay>

        <Overlay checked={filters.showAccidents} name="Accidents">
          <>
            {accidents
              .filter((accident: Accident) => !accident.resolved)
              .map((accident: Accident) => (
                <Marker
                  key={accident.id}
                  position={[accident.location.latitude, accident.location.longitude]}
                  icon={accidentIconBySeverity(accident.severity)}
                  eventHandlers={{
                    click: () => setSelectedAccident(accident),
                  }}
                >
                  <Tooltip direction="top" offset={[0, -40]} opacity={0.9}>
                    {accident.severity.toUpperCase()} - {accident.type}
                  </Tooltip>
                  <Popup>
                    <div className="p-3 min-w-[260px]">
                      <h3 className="font-bold text-lg mb-2 text-red-600">Accident</h3>
                      <p className="text-sm text-gray-600 mb-2">{accident.location.address}</p>
                      
                      <div className="space-y-1 mb-2">
                        <p className="text-sm">
                          <span className="font-semibold">Type:</span> {accident.type}
                        </p>
                        <p className="text-sm">
                          <span className="font-semibold">Severity:</span>{' '}
                          <span
                            className={`font-semibold ${
                              accident.severity === 'fatal'
                                ? 'text-black'
                                : accident.severity === 'severe'
                                ? 'text-red-600'
                                : accident.severity === 'moderate'
                                ? 'text-orange-600'
                                : 'text-yellow-600'
                            }`}
                          >
                            {accident.severity.toUpperCase()}
                          </span>
                        </p>
                        {accident.vehicles !== undefined && (
                          <p className="text-sm">
                            <span className="font-semibold">Vehicles:</span> {accident.vehicles}
                          </p>
                        )}
                        {accident.casualties !== undefined && accident.casualties > 0 && (
                          <p className="text-sm font-semibold text-red-600">
                            Casualties: {accident.casualties}
                          </p>
                        )}
                        <p className="text-xs text-gray-500">
                          {format(parseISO(accident.timestamp || accident.dateDetected || new Date().toISOString()), 'PPpp')}
                        </p>
                      </div>
                      
                      {accident.description && (
                        <p className="text-sm mt-2 p-2 bg-gray-100 rounded">{accident.description}</p>
                      )}
                    </div>
                  </Popup>
                </Marker>
              ))}
          </>
        </Overlay>

        <Overlay checked={filters.showWeather} name="Weather">
          <>
            {weather.map((w: Weather) => (
              <Marker
                key={w.id}
                position={[w.location.latitude, w.location.longitude]}
                icon={weatherIcon}
              >
                <Tooltip direction="top" offset={[0, -40]} opacity={0.9}>
                  {w.temperature}°C - {w.condition}
                </Tooltip>
                <Popup>
                  <div className="p-3 min-w-[240px]">
                    <h3 className="font-bold text-lg mb-2">Weather</h3>
                    <p className="text-sm text-gray-600 mb-2">{w.location.district}</p>
                    
                    <div className="space-y-1">
                      <p className="text-sm">
                        <span className="font-semibold">Temperature:</span> {w.temperature}°C
                      </p>
                      <p className="text-sm">
                        <span className="font-semibold">Humidity:</span> {w.humidity}%
                      </p>
                      <p className="text-sm">
                        <span className="font-semibold">Rainfall:</span> {w.rainfall}mm
                      </p>
                      <p className="text-sm">
                        <span className="font-semibold">Wind:</span> {w.windSpeed}km/h {w.windDirection}
                      </p>
                      <p className="text-sm">
                        <span className="font-semibold">Condition:</span> {w.condition}
                      </p>
                    </div>
                  </div>
                </Popup>
              </Marker>
            ))}
          </>
        </Overlay>

        <Overlay checked={filters.showAirQuality} name="Air Quality">
          <>
            {airQuality.map((aq: AirQuality) => (
              <Marker
                key={aq.id}
                position={[aq.location.latitude, aq.location.longitude]}
                icon={airQualityIconByLevel(aq.level)}
              >
                <Tooltip direction="top" offset={[0, -40]} opacity={0.9}>
                  AQI: {aq.aqi} ({aq.level})
                </Tooltip>
                <Popup>
                  <div className="p-3 min-w-[240px]">
                    <h3 className="font-bold text-lg mb-2">Air Quality</h3>
                    <p className="text-sm text-gray-600 mb-2">{aq.location.station}</p>
                    
                    <div className="space-y-1">
                      <p className="text-sm">
                        <span className="font-semibold">AQI:</span>{' '}
                        <span
                          className="font-semibold text-lg"
                          style={{ color: getAQIColor(aq.level) }}
                        >
                          {aq.aqi}
                        </span>
                        {' '}({aq.level})
                      </p>
                      <p className="text-sm">
                        <span className="font-semibold">PM2.5:</span> {aq.pm25} µg/m³
                      </p>
                      <p className="text-sm">
                        <span className="font-semibold">PM10:</span> {aq.pm10} µg/m³
                      </p>
                      <p className="text-sm">
                        <span className="font-semibold">CO:</span> {aq.co} ppm
                      </p>
                      <p className="text-sm">
                        <span className="font-semibold">NO2:</span> {aq.no2} ppb
                      </p>
                    </div>
                  </div>
                </Popup>
              </Marker>
            ))}
          </>
        </Overlay>

        <Overlay checked={filters.showPatterns} name="Traffic Patterns">
          <>
            {patterns.map((pattern: TrafficPattern) => {
              if (pattern.location && pattern.location.startPoint && pattern.location.endPoint) {
                const positions: LatLngExpression[] = [
                  [pattern.location.startPoint.latitude, pattern.location.startPoint.longitude],
                  [pattern.location.endPoint.latitude, pattern.location.endPoint.longitude],
                ];
                return (
                  <Polyline
                    key={pattern.id}
                    positions={positions}
                    color={getCongestionColor(pattern.congestionLevel)}
                    weight={5}
                    opacity={0.7}
                    eventHandlers={{
                      click: () => setSelectedPattern(pattern),
                    }}
                  >
                    <Popup>
                      <div className="p-3 min-w-[240px]">
                        <h3 className="font-bold text-lg mb-2">Traffic Pattern</h3>
                        {pattern.roadSegment && (
                          <p className="text-sm text-gray-600 mb-2">{pattern.roadSegment}</p>
                        )}
                        
                        <div className="space-y-1">
                          <p className="text-sm">
                            <span className="font-semibold">Type:</span> {pattern.patternType}
                          </p>
                          <p className="text-sm">
                            <span className="font-semibold">Congestion:</span>{' '}
                            <span
                              className="font-semibold"
                              style={{ color: getCongestionColor(pattern.congestionLevel) }}
                            >
                              {pattern.congestionLevel}
                            </span>
                          </p>
                          {pattern.timeRange && (
                            <p className="text-sm">
                              <span className="font-semibold">Time:</span> {pattern.timeRange}
                            </p>
                          )}
                          {pattern.averageSpeed !== undefined && (
                            <p className="text-sm">
                              <span className="font-semibold">Avg Speed:</span> {pattern.averageSpeed} km/h
                            </p>
                          )}
                          {pattern.vehicleCount !== undefined && (
                            <p className="text-sm">
                              <span className="font-semibold">Vehicles:</span> {pattern.vehicleCount}
                            </p>
                          )}
                          {pattern.predictions && (
                            <p className="text-sm mt-2 p-2 bg-blue-50 rounded">
                              <span className="font-semibold">Prediction:</span> {pattern.predictions.nextHour} km/h
                              <br />
                              <span className="text-xs">({(pattern.predictions.confidence * 100).toFixed(1)}% confidence)</span>
                            </p>
                          )}
                        </div>
                      </div>
                    </Popup>
                  </Polyline>
                );
              }
              return null;
            })}
          </>
        </Overlay>
      </LayersControl>
    </MapContainer>
  );
};

export default TrafficMap;
